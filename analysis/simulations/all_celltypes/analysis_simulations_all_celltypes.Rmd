---
title: "Analysis for simulations on brain."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(miloDE)
library(miloR)
library(ggplot2)
library(ggpubr)
library(viridis)
library(MetBrewer)
library(BiocParallel)

ncores = 5
mcparam = MulticoreParam(workers = ncores)
register(mcparam)

set.seed(32)

root.dir = "/nfs/research/marioni/alsu/hubmap_metaRef/"
figures.dir = paste0(root.dir , "figures/detection_analysis/chimera_embryo/all_celltypes/")


# load data

celltypes = list("PGC" , "Blood progenitors 1" , "Blood progenitors 2" , "Erythroid1" , "Endothelium" , "Cardiomyocytes" , "Gut" ,  "Allantois" , "Pharyngeal mesoderm" , "Paraxial mesoderm" , "Mesenchyme" ,  c("Somitic mesoderm" , "Intermediate mesoderm" , "NMP") , c("Gut" , "Surface ectoderm") ,  "Forebrain/Midbrain/Hindbrain" , "Erythroid3" , c("Forebrain/Midbrain/Hindbrain" , "Spinal cord") , c("Forebrain/Midbrain/Hindbrain" , "Spinal cord" , "NMP") ,
                 c("Erythroid1" ,"Erythroid2" ,"Erythroid3") , c("Erythroid1" ,"Erythroid2" ,"Erythroid3" , "Blood progenitors 1" , "Blood progenitors 2" ) ,
                 c("Forebrain/Midbrain/Hindbrain" , "Spinal cord" , "NMP" , "Somitic mesoderm" , "Intermediate mesoderm") )

simulated_genes = readRDS(file = paste0(root.dir , "data/processed/simulations/all_celltypes/simulated_genes.Rds"))
sces = readRDS(paste0(root.dir , "data/processed/simulations/all_celltypes/sces_simulated.Rds"))

milo_de_stat = readRDS(paste0(root.dir , "data/processed/simulations/all_celltypes/milo_de_stat__recalculated_embedding.Rds"))
bulk_de_stat = readRDS(paste0(root.dir , "data/processed/simulations/all_celltypes/bulk_de_stat.Rds"))

meta = as.data.frame(colData(sces[[1]]))

```

# Unlist miloDE and bulkDE with assigning % of cells perturbed

```{r unlist-clusts, message = FALSE}


celltypes_df = lapply(1:length(celltypes) , function(i){
  out = round( mean(meta$celltype %in% celltypes[[i]]) , 3 )
  out = data.frame(idx = i , prop = out)
  return(out)
})
celltypes_df = do.call(rbind , celltypes_df)



bulk_de_stat = lapply(1:length(bulk_de_stat) , function(i){
  current.stat = bulk_de_stat[[i]]
  current.stat$logFC_bulk_all = -1*(current.stat$logFC_bulk_all)
  current.stat$logFC_bulk_celltypes = -1*(current.stat$logFC_bulk_celltypes)
  current.stat$logFC_bulk_all_round = round(current.stat$logFC_bulk_all , 1)
  current.stat$logFC_bulk_celltypes_round = round(current.stat$logFC_bulk_celltypes , 1)
  current.stat = cbind(current.stat , celltypes_df[i,])
  return(current.stat)
})
bulk_de_stat = do.call(rbind , bulk_de_stat)


milo_de_stat = lapply(1:length(milo_de_stat) , function(i){
  current.stat = milo_de_stat[[i]]
  current.stat = cbind(current.stat , celltypes_df[i,])
  return(current.stat)
})
milo_de_stat = do.call(rbind , milo_de_stat)


```

# Overview of perturbed cells

```{r load-data, message = FALSE}


sce = sces[[1]]
umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce , "scvi_supervised_wt"))) )
reducedDim(sce , paste0("umap_" , "scvi_supervised_wt")) = umaps

cols = c("#899DA4" , "#C93312")
names(cols) = c(F,T)


get_plot_per_cluster_split = function(idx){
  current.clusters = celltypes[[idx]]
  sce$perturbed = sce$celltype %in% current.clusters
  
  meta = cbind(as.data.frame(colData(sce)) , as.data.frame(reducedDim(sce , "umap_scvi_supervised_wt")))
  meta = meta[order(meta$perturbed) , ]
  p = ggplot(meta , aes(x = V1 , y = V2 , col = perturbed)) + 
    geom_point(size = .5 , alpha = .9) +
    theme_bw() + 
    scale_color_manual(values = cols) + 
    ggtitle(paste0("Prop. = ", celltypes_df$prop[celltypes_df$idx == idx]))
  return(p)
}

plots = lapply(setdiff( c(1:length(celltypes)) , c(1,2,19,20)) , function(i){
  p = get_plot_per_cluster_split(i)
  return(p)
})
p = ggarrange(plotlist = plots , nrow = 4 , ncol = 4, common.legend = T)
p
ggsave(filename = paste0(figures.dir, "overview_perturbations", ".png"), plot = p, width = 12, height = 9)


```


# bulkDE stat

## Heatmap: lfc x prop

```{r load-data, message = FALSE}


bulk_de_stat_combined = as.data.frame(bulk_de_stat %>% group_by(idx , prop , logFC_bulk_celltypes_round) %>% 
                                        dplyr::summarise(frac_genes_sig = mean(PValue_bulk_all < 0.05) , 
                                                         avg_logFC_all = mean(logFC_bulk_all_round)))
bulk_de_stat_combined = bulk_de_stat_combined[!bulk_de_stat_combined$idx %in% c(1,2,19,20),]

p = ggplot(bulk_de_stat_combined[bulk_de_stat_combined$logFC_bulk_celltypes_round < 4 & bulk_de_stat_combined$logFC_bulk_celltypes_round > 0, ] , aes(x = factor(prop) , y = factor(logFC_bulk_celltypes_round) , fill = frac_genes_sig)) + 
  geom_tile() + 
  scale_fill_viridis(discrete = F , name = "% genes\ndet. as DE") +
  theme_bw() + 
  labs(x = "Proportion of perturbed cells" , y = "logFC for perturbed cells") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
ggsave(filename = paste0(figures.dir, "bulk_de/heatmap__det_rate", ".png"), plot = p, width = 6, height = 6)


p = ggplot(bulk_de_stat_combined[bulk_de_stat_combined$logFC_bulk_celltypes_round < 4 & bulk_de_stat_combined$logFC_bulk_celltypes_round > 0, ] , aes(x = factor(prop) , y = factor(logFC_bulk_celltypes_round) , fill = avg_logFC_all)) + 
  geom_tile() + 
  scale_fill_viridis(discrete = F, name = "abs\nlogFC") +
  theme_bw() + 
  labs(x = "Proportion of perturbed cells" , y = "logFC for perturbed cells") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
ggsave(filename = paste0(figures.dir, "bulk_de/heatmap__abs_logFC", ".png"), plot = p, width = 6, height = 6)


```

## compare logFC (abs vs perturbed)

```{r load-data, message = FALSE}


cols = wes_palette("Zissou1", length(unique(bulk_de_stat$prop)), type = "continuous")

df = bulk_de_stat[bulk_de_stat$logFC_bulk_celltypes < 4 & bulk_de_stat$logFC_bulk_celltypes > 0 ,]
df = df[sample(nrow(df)) , ]
p = ggplot(df, aes(y = logFC_bulk_all , x = logFC_bulk_celltypes , col = factor(prop))) +
  geom_point(alpha = .75 , size = .75) +
  theme_bw() +
  scale_color_manual(values = cols[1:length(unique(bulk_de_stat$prop))] , name = "Prop. of\nperturbed\ncells") + 
  geom_abline(slope = 1 , "linetype" = "dashed" , color = "black") + 
  labs(x = "Estimated logFC in perturbed sub-population" , y = "logFC from DE test") 
p
ggsave(filename = paste0(figures.dir, "bulk_de/scater_logFC", ".png"), plot = p, width = 7, height = 6)





```

# miloDE - sensitivity of DE detection

## Get stat

For each simulation, nhood assignment, gene and CT purity thresh - get sensitivity and FDR

```{r load-data, message = FALSE}


ct_purity.thresh = c(0, 0.1 , 0.25 , 0.5)

milo_de_stat_combined = lapply(ct_purity.thresh , function(ct_purity){
  out = as.data.frame(milo_de_stat %>% group_by(idx , prop , order , k , round , id , ENSEMBL , SYMBOL ) %>% 
                        dplyr::summarise(sensitivity = sum(pval < 0.05 & celltype_purity > ct_purity)/sum(celltype_purity > ct_purity) , 
                                         fdr = sum(pval < 0.05 & celltype_purity <= ct_purity)/sum(pval < 0.05) ))
  out$ct_purity.thresh = ct_purity
  return(out)
})
milo_de_stat_combined = do.call(rbind, milo_de_stat_combined)
milo_de_stat_combined = merge(milo_de_stat_combined , bulk_de_stat[, c("ENSEMBL" , "idx" , "logFC_bulk_celltypes_round")] , by = c("ENSEMBL" , "idx") , all.x = T , all.y = F)


milo_de_stat_combined = as.data.frame(milo_de_stat_combined %>% group_by(idx , prop ,logFC_bulk_celltypes_round , ct_purity.thresh) %>% 
                                        dplyr::summarise(sensitivity = mean(sensitivity , na.rm = T) , fdr = mean(fdr , na.rm = T)))

milo_de_stat_combined = milo_de_stat_combined[!milo_de_stat_combined$idx %in% c(1,2,19,20),]

plots = lapply(unique(milo_de_stat_combined$ct_purity.thresh) , function(ct_purity){
  current.stat = milo_de_stat_combined[milo_de_stat_combined$logFC_bulk_celltypes_round < 4 & milo_de_stat_combined$logFC_bulk_celltypes_round > 0 & milo_de_stat_combined$ct_purity.thresh == ct_purity, ]
  
  p = ggplot(current.stat , aes(x = factor(prop) , y = factor(logFC_bulk_celltypes_round) , fill = sensitivity)) + 
    geom_tile() + 
    scale_fill_viridis(discrete = F , name = "Sensitivity") +
    theme_bw() +
    labs(x = "Proportion of perturbed cells" , y = "logFC for perturbed cells") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  ggsave(filename = paste0(figures.dir, "milo_de/heatmaps_sensitivity/ct_purity_", ct_purity , ".png"), plot = p, width = 6, height = 6)
  
  p = ggplot(current.stat , aes(x = factor(prop) , y = factor(logFC_bulk_celltypes_round) , fill = fdr)) + 
    geom_tile() + 
    scale_fill_viridis(discrete = F , name = "FDR") +
    theme_bw() +
    labs(x = "Proportion of perturbed cells" , y = "logFC for perturbed cells") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  p
  ggsave(filename = paste0(figures.dir, "milo_de/heatmaps_fdr/ct_purity_", ct_purity , ".png"), plot = p, width = 6, height = 6)
})



```

## Compare logFC (abs vs perturbed)

```{r load-data, message = FALSE}


cols = wes_palette("Zissou1", length(unique(bulk_de_stat$prop)), type = "continuous")


df = merge(milo_de_stat , bulk_de_stat[, c("ENSEMBL" , "idx" , "logFC_bulk_celltypes")] , by = c("ENSEMBL" , "idx") , all.x = T , all.y = F)
df = df[df$logFC_bulk_celltypes < 4 & df$logFC_bulk_celltypes > 0 ,]
df$logFC = -1*df$logFC 
df = df[!is.na(df$prop) , ]
df = df[sample(nrow(df)) , ]
df = df[!df$idx %in% c(1,2,19,20),]
df = df[!is.na(df$pval) , ]

cols = wes_palette("Zissou1", length(unique(df$prop)), type = "continuous")

p1 = ggplot(df[df$celltype_purity > 0.1 & df$pval_corrected_across_nhoods < 0.1, ], aes(y = logFC , x = logFC_bulk_celltypes , col = factor(prop))) +
  geom_point(alpha = .75 , size = .75) +
  theme_bw() +
  scale_color_manual(values = cols[1:length(unique(bulk_de_stat$prop))] , name = "Prop. of\nperturbed\ncells") + 
  geom_abline(slope = 1 , "linetype" = "dashed" , color = "black") + 
  labs(x = "Estimated logFC in perturbed sub-population" , y = "logFC from DE test") 
p2 = ggplot(df[df$celltype_purity > 0.1 & df$pval_corrected_across_nhoods < 0.1, ], aes(y = logFC , x = logFC_bulk_celltypes , col = celltype_purity)) +
  geom_point(alpha = .75 , size = .75) +
  theme_bw() +
  geom_abline(slope = 1 , "linetype" = "dashed" , color = "black") + 
  scale_color_viridis(discrete = F , option = "cividis" , name = "Nhood\npurity") +
  labs(x = "Estimated logFC in perturbed sub-population" , y = "logFC from DE test") 
p = ggarrange(p1,p2)
p
ggsave(filename = paste0(figures.dir, "milo_de/scater_logFC", ".png"), plot = p, width = 10, height = 5)





```


## Robustness - based on k and on replicate of the simulation

@@ talk to John what is the best way to show it

```{r load-data, message = FALSE}






```

# Session Info

```{r sessinf}
sessionInfo()
```
