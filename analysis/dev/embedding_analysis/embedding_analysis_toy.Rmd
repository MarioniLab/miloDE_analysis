---
title: "This pipeline to illustrate how different gene selection contribute to different discovery rate"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(miloDE)
library(miloR)
library(BiocParallel)
library(ggplot2)
library(ggpubr)
library(geneBasisR)
library(MouseGastrulationData)
library(scran)
library(MetBrewer)

ncores = 1
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)


root.dir = "/nfs/research/marioni/alsu/hubmap_metaRef/"
figures.dir = paste0(root.dir , "figures/optimal_coverage/embedding_updated/toy/")


```

# Generate toy data

```{r get-toy-data, message = FALSE}


# reference
gene_1 = c( runif(1000, min = 0, max = 0.25) , runif(1000, min = 0.75, max = 1))
gene_2 = c( runif(2000, min = 0, max = 1))
sce_reference = SingleCellExperiment(list(counts = rbind(gene_1 , gene_2)))
sce_reference$cell = paste0("ref_" , c(1:2000))
colnames(sce_reference) = sce_reference$cell
sce_reference$type = "WT"
sce_reference$sample = c(rep("sample1" , 1 , 500) , rep("sample2" , 1 , 500) , rep("sample1" , 1 , 500) , rep("sample2" , 1 , 500))

# query
gene_1 = c( runif(1000, min = 0, max = 0.25) , runif(1000, min = 0.75, max = 1))
gene_2 = c( runif(2000, min = 0.5, max = 1))
sce_query = SingleCellExperiment(list(counts = rbind(gene_1 , gene_2)))
sce_query$cell = paste0("query_" , c(1:2000))
colnames(sce_query) = sce_query$cell
sce_query$type = "Disease"
sce_query$sample = c(rep("sample3" , 1 , 500) , rep("sample4" , 1 , 500) , rep("sample3" , 1 , 500) , rep("sample4" , 1 , 500))

sce = cbind(sce_reference , sce_query)
reducedDim(sce , "counts_gene_1_2") = t(counts(sce))
reducedDim(sce , "counts_gene_1") = t(counts(sce["gene_1" , ]))


# visualiase
df = as.data.frame(t(counts(sce)))
df$type = sce$type
df$type = factor(df$type , levels = c("WT" , "Disease"))

p = ggplot(df , aes(x = gene_1 , y = gene_2 , col = type)) +
  geom_point(size = .5) +
  theme_classic() +
  facet_wrap(~type) + 
  scale_color_manual(values = wes_palette("Royal1" , 2)) + 
  labs(x = "Gene 1" , y = "Gene 2") +
  theme(legend.position = "none")
p
ggsave(filename = paste0(figures.dir, "umap", ".png"), plot = p, width = 6, height = 3)



```

# Assign neighbourhoods using one or all genes

```{r check-chimera-genes, message = FALSE}


sce_milo_gene_1_2 = miloDE::assign_neighbourhoods(sce , reducedDim_name = "counts_gene_1_2" , k = 150 , order = 1 , filtering = T , d = 2)
nhood_stat_1_2 = data.frame(Nhood = c(1:ncol(nhoods(sce_milo_gene_1_2))))
nhood_stat_1_2 = annotateNhoods(sce_milo_gene_1_2 , da.res = nhood_stat_1_2 , coldata_col = "type")
nhood_stat_1_2$wt_fraction = nhood_stat_1_2$type_fraction
nhood_stat_1_2$wt_fraction[nhood_stat_1_2$type == "Disease"] = 1 - nhood_stat_1_2$type_fraction[nhood_stat_1_2$type == "Disease"]

sce_milo_gene_1 = miloDE::assign_neighbourhoods(sce , reducedDim_name = "counts_gene_1" , k = 150 , order = 1 , filtering = T , d = 2)
nhood_stat_1 = data.frame(Nhood = c(1:ncol(nhoods(sce_milo_gene_1))) )
nhood_stat_1 = annotateNhoods(sce_milo_gene_1 , da.res = nhood_stat_1 , coldata_col = "type")
nhood_stat_1$wt_fraction = nhood_stat_1$type_fraction
nhood_stat_1$wt_fraction[nhood_stat_1$type == "Disease"] = 1 - nhood_stat_1$type_fraction[nhood_stat_1$type == "Disease"]


# visualise
p1 = plot_milo_by_single_metric(sce_milo_gene_1_2 , nhood_stat = nhood_stat_1_2 , colour_by = "wt_fraction" , layout = "counts_gene_1_2") + 
  scale_fill_viridis(discrete = F , name = "% of WT\ncells") + guides(width="none" ,edge_width="none",size="none")
p1
ggsave(filename = paste0(figures.dir, "milo_1_2", ".png"), plot = p1, width = 4, height = 3)

p2 = plot_milo_by_single_metric(sce_milo_gene_1 , nhood_stat = nhood_stat_1 , colour_by = "wt_fraction" , layout = "counts_gene_1_2") + 
  scale_fill_viridis(discrete = F , name = "% of WT\ncells") + guides(width="none" ,edge_width="none",size="none")
p2
ggsave(filename = paste0(figures.dir, "milo_1", ".png"), plot = p2, width = 4, height = 3)


```

# Compare boxplots

```{r miloDE-testing, message = FALSE}


get_counts_distr = function(sce_milo){
  nhoods_sce = nhoods(sce_milo)
  df = lapply(1:ncol(nhoods_sce) , function(i){
    current.cells = which(nhoods_sce[,i] == 1)
    current.cells = rownames(nhoods_sce)[current.cells]
    current.sce = sce[, sce$cell %in% current.cells]
    out = data.frame(type = current.sce$type ,  counts = as.numeric(counts(current.sce["gene_2",])) , avg_counts = mean(as.numeric(counts(current.sce["gene_2",]))) , Nhood = i)
    return(out)
  })
  df = do.call(rbind , df)
  # get nhood sorting
  df_combined = as.data.frame(df %>% group_by(Nhood) %>% dplyr::summarise(avg_counts = mean(avg_counts)))
  df_combined = df_combined[order(df_combined$avg_counts) , ]
  df$Nhood = factor(df$Nhood , levels = df_combined$Nhood)
  df$type = factor(df$type , levels = c("WT" , "Disease"))
  return(df)
}


df_gene_1_2 = get_counts_distr(sce_milo_gene_1_2)
df_gene_1 = get_counts_distr(sce_milo_gene_1)


p = ggplot(df_gene_1_2 , aes(x = Nhood , y = counts , fill = type)) +
  geom_boxplot() + 
  theme_classic() + 
  scale_fill_manual(values = wes_palette("Royal1" , 2)) +
  theme(axis.text.x = element_blank()) + 
  labs(x = "Neighbourhood" , y = "Counts") +
  theme(legend.position = "none")
p
ggsave(filename = paste0(figures.dir, "boxplot_1_2", ".png"), plot = p, width = 6, height = 2.5)

p = ggplot(df_gene_1 , aes(x = Nhood , y = counts , fill = type)) +
  geom_boxplot() + 
  theme_classic() + 
  scale_fill_manual(values = wes_palette("Royal1" , 2)) +
  theme(axis.text.x = element_blank()) + 
  labs(x = "Neighbourhood" , y = "Counts") +
  theme(legend.position = "none")
p
ggsave(filename = paste0(figures.dir, "boxplot_1", ".png"), plot = p, width = 6, height = 2.5)



```



# Session Info

```{r sessinf}
sessionInfo()
```
