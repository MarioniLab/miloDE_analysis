---
title: "This pipeline to analyse DA-DE data for chimera blood"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(BiocParallel)
library(geneBasisR)
library(splatter)
library(scran)
library(miloR)
library(miloDE)

ncores = 5
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)

root.dir = "/nfs/research/marioni/alsu/hubmap_metaRef/"
source(paste0(root.dir , "miloDE_analysis/core_functions.R"))


# origianl sce
sce = readRDS(paste0(root.dir , "data/sces/mouse_embryo/chimera_WT/mouse_embryo_wt_chimera.Rds"))
sce = sce[ , sce$celltype %in% c("Erythroid2" , "Erythroid3")]

# generated simulation data
sces = readRDS(file = paste0(root.dir , "data/processed/da_de/simulations_splatter/sims.Rds"))
simulated_genes = readRDS(file = paste0(root.dir , "data/processed/da_de/simulations_splatter/simulated_genes.Rds"))
stat_da = readRDS(file = paste0(root.dir , "data/processed/da_de/simulations_splatter/stat_da.Rds"))
stat_de = readRDS(file = paste0(root.dir , "data/processed/da_de/simulations_chimera/blood/stat_de.Rds"))

anno_1 = expand.grid(order = 1 , k = c(100,200) , seed = c(13,17,32))
anno_2 = expand.grid(order = 2 , k = c(15,25) , seed = c(13,17,32))
anno = rbind(anno_1 , anno_2)




```

# Test

```{r control-no-perturbation, message = FALSE}


samples = AtlasSampleMetadata$sample[AtlasSampleMetadata$stage == "E8.5"]
sce <- lapply(samples , function(sample){
  out = EmbryoAtlasData(samples = sample)
  return(out)
})
sce = do.call(cbind , sce)
sce = sce[, sce$celltype %in% c("Erythroid2" , "Erythroid3")]


rowdata = as.data.frame(rowData(sce))
idx = which(gdata::startsWith(rowdata$SYMBOL , "Hba") | gdata::startsWith(rowdata$SYMBOL , "Hbb") | gdata::startsWith(rowdata$SYMBOL , "mt") | gdata::startsWith(rowdata$SYMBOL , "Rpl") | gdata::startsWith(rowdata$SYMBOL , "Rps"))
sce = sce[setdiff(1:nrow(sce) , idx) ,]
# actively discard couple other strong markers
sce = sce[!rownames(sce) %in% c("ENSMUSG00000027562" , "ENSMUSG00000026688") , ]

sce = scuttle::logNormCounts(sce)
hvgs = scran::getTopHVGs(sce , n = 500)


sce$type = sapply(1:ncol(sce) , function(i) ifelse(sce$sample[i] %in% c("36" , "17") , "cond_A" , "cond_B"))


sce_sim = sce
sce_sim = add_batch_corrected_supervised_pca(sce_sim, genes = hvgs, reduced.dim_name = "pca.0" , batch = "sample" , d = 3)
#umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce_sim , "pca.0"))) )
#reducedDim(sce_sim , "UMAP.0") = umaps
reducedDim(sce_sim , "UMAP.0") = reducedDim(sce_sim , "pca.0")



add_simulated_counts <- function(sce, gene, frac_cells_change, range){
  counts = counts(sce)
  current.counts = counts[gene, ]
  idx_2_change = which(sce$type == "cond_B" & sce$celltype %in% c("Erythroid2" , "Erythroid1"))
  idx_2_change = sample(idx_2_change , round(length(idx_2_change)*frac_cells_change))
  current.counts[idx_2_change] = current.counts[idx_2_change] + floor(runif(length(idx_2_change), min=range[1], max=(range[2]+1)))
  counts[gene, ] = current.counts
  counts(sce) = counts
  return(sce)
}



for (i in 1:nrow(markers)){
  print(i)
  sce_sim = add_simulated_counts(sce_sim, 
                               gene = markers$ENSEMBL[i], 
                               range = c(6,8) , 
                               frac_cells_change = 1)
}

sce_sim = scuttle::logNormCounts(sce_sim)
# add re-computed embedding
sce_sim = add_batch_corrected_supervised_pca(sce_sim, genes = hvgs, reduced.dim_name = "pca.1" , batch = "sample" , d = 3)
#umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce_sim , "pca.1"))) )
#reducedDim(sce_sim , "UMAP.1") = umaps
reducedDim(sce_sim , "UMAP.1") = reducedDim(sce_sim , "pca.1")






sce_milo.0 = miloDE::assign_neighbourhoods(sce_sim , reducedDim_name = "pca.0" , order = 2 , k = 5 , d = 5 , verbose = F , filtering = T)
sce_milo.1 = miloDE::assign_neighbourhoods(sce_sim , reducedDim_name = "pca.1" , order = 2 , k = 5 , d = 5 , verbose = F , filtering = T)
da.0 = get_milo_stat( sce_milo.0 , "pca.0")
da.1 = get_milo_stat( sce_milo.1 , "pca.1")


p1 = plot_milo_by_single_metric(sce_milo.0 , da.0 , significance_by = "PValue" , alpha = .1 ,  layout = "UMAP.0")
p1
p2 = plot_milo_by_single_metric(sce_milo.1 , da.1 , significance_by = "PValue" , alpha = .1,  layout = "UMAP.1")
p2

meta = cbind( as.data.frame(colData(sce_milo.0)) , as.data.frame(reducedDim(sce_milo.0 , "UMAP.0")))
p = ggplot(meta , aes(x = V1 , y = V2 , col = type)) +
  geom_point(alpha = .5) +
  theme_bw() +
  facet_wrap(~celltype)
p
meta = cbind( as.data.frame(colData(sce_milo.1)) , as.data.frame(reducedDim(sce_milo.1 , "UMAP.1")))
p = ggplot(meta , aes(x = V1 , y = V2 , col = type)) +
  geom_point(alpha = .5) +
  theme_bw() +
  facet_wrap(~celltype)
p






```

# Test

```{r control-no-perturbation, message = FALSE}


sce = readRDS(paste0(root.dir , "data/sces/mouse_embryo/chimera_WT/mouse_embryo_wt_chimera.Rds"))
sce = sce[, sce$type == "wt"]
sce = sce[, sce$celltype %in% c("Erythroid2" , "Erythroid3")]

sce$type = sapply(1:ncol(sce) , function(i) ifelse(sce$sample[i] %in% c("36" , "17") , "cond_A" , "cond_B"))

# Add pseudotime
slingshot_res <- slingPseudotime(slingshot(as.matrix(reducedDim(sce , "mnn_unsupervised_wt"))))
sce$pt = as.numeric(slingshot_res)




rowdata = as.data.frame(rowData(sce))
idx = which(gdata::startsWith(rowdata$SYMBOL , "Hba") | gdata::startsWith(rowdata$SYMBOL , "Hbb") | gdata::startsWith(rowdata$SYMBOL , "mt") | gdata::startsWith(rowdata$SYMBOL , "Rpl") | gdata::startsWith(rowdata$SYMBOL , "Rps"))
sce = sce[setdiff(1:nrow(sce) , idx) ,]
# actively discard couple other strong markers
sce = sce[!rownames(sce) %in% c("ENSMUSG00000027562" , "ENSMUSG00000026688") , ]

sce = scuttle::logNormCounts(sce)
hvgs = scran::getTopHVGs(sce , n = 500)



sce_sim = sce
sce_sim = add_batch_corrected_pca(sce_sim, genes = hvgs, reduced.dim_name = "pca.0" , batch = "sample" , d = 3)
#umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce_sim , "pca.0"))) )
#reducedDim(sce_sim , "UMAP.0") = umaps
reducedDim(sce_sim , "UMAP.0") = reducedDim(sce_sim , "pca.0")

med_pt = median(sce_sim$pt)


add_simulated_counts <- function(sce, gene, frac_cells_change, range){
  counts = counts(sce)
  current.counts = counts[gene, ]
  #idx_2_change = which(sce$type == "cond_B" & sce$pt <= 20)
  idx_2_change = which(sce$type == "cond_B" & (sce$celltype == "Erythroid2" | sce$pt < 14))
  idx_2_change = sample(idx_2_change , round(length(idx_2_change)*frac_cells_change))
  current.counts[idx_2_change] = current.counts[idx_2_change] + floor(runif(length(idx_2_change), min=range[1], max=(range[2]+1)))
  counts[gene, ] = current.counts
  counts(sce) = counts
  return(sce)
}



for (i in 1:nrow(markers)){
  print(i)
  sce_sim = add_simulated_counts(sce_sim, 
                               gene = markers$ENSEMBL[i], 
                               range = c(7,10) , 
                               frac_cells_change = 1)
}

sce_sim = scuttle::logNormCounts(sce_sim)
# add re-computed embedding
sce_sim = add_batch_corrected_pca(sce_sim, genes = hvgs, reduced.dim_name = "pca.1" , batch = "sample" , d = 3)
#umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce_sim , "pca.1"))) )
#reducedDim(sce_sim , "UMAP.1") = umaps
reducedDim(sce_sim , "UMAP.1") = reducedDim(sce_sim , "pca.1")






sce_milo.0 = miloDE::assign_neighbourhoods(sce_sim , reducedDim_name = "pca.0" , order = 1 , k = 20 , d = 5 , verbose = F , filtering = T)
sce_milo.1 = miloDE::assign_neighbourhoods(sce_sim , reducedDim_name = "pca.1" , order = 1 , k = 20 , d = 5 , verbose = F , filtering = T)
da.0 = get_milo_stat( sce_milo.0 , "pca.0")
da.1 = get_milo_stat( sce_milo.1 , "pca.1")


p1 = plot_milo_by_single_metric(sce_milo.0 , da.0 , significance_by = "PValue" , alpha = .1 ,  layout = "UMAP.0")
p1
p2 = plot_milo_by_single_metric(sce_milo.1 , da.1 , significance_by = "PValue" , alpha = .1,  layout = "UMAP.1")
p2


meta = cbind( as.data.frame(colData(sce_milo.0)) , as.data.frame(reducedDim(sce_milo.0 , "UMAP.0")))
p = ggplot(meta , aes(x = V1 , y = V2 , col = type)) +
  geom_point(alpha = .5) +
  theme_bw() +
  facet_wrap(~celltype)
p
meta = cbind( as.data.frame(colData(sce_milo.1)) , as.data.frame(reducedDim(sce_milo.1 , "UMAP.1")))
meta$bool = meta$pt < 14
p = ggplot(meta , aes(x = V1 , y = V2 , col = sample)) +
  geom_point(alpha = .5) +
  theme_bw() +
  facet_wrap(~celltype)
p




meta = as.data.frame(colData(sce_milo.1))
p = ggplot(meta , aes(x = sample , y = pt , fill = type)) +
  geom_boxplot() 
p



```


```{r control-no-perturbation, message = FALSE}




add_batch_corrected_supervised_pca = function(sce, genes , reduced.dim_name = "pca.corrected" , batch = "sample" , d = 30){
  require(batchelor)
  sce_ref = sce[, sce$type == "cond_A"]
  sce_query = sce[, !sce$type == "cond_A"]
  
  meta_ref = as.data.frame(colData(sce_ref))
  batchFactor_ref = factor(meta_ref[, colnames(meta_ref) == batch])
  
  full_pca = multiBatchPCA(sce_ref[genes,] , batch = batchFactor_ref , d = d, preserve.single = TRUE, assay.type = "logcounts")
  ref_pca <- full_pca[[1]]
  to_proj <- (as.matrix(logcounts(sce_query)[genes,]) - rowMeans(as.matrix(logcounts(sce_query)[genes,])))/sqrt(rowVars(as.matrix(logcounts(sce_query)[genes,])))

  map_pca <- t(to_proj) %*% metadata(full_pca)$rotation
  big_pca <- rbind(ref_pca, map_pca)
  # reorder
  big_pca = big_pca[order(rownames(big_pca)) , ]
  sce = sce[ , order(colnames(sce))]
  
  # correct
  meta = as.data.frame(colData(sce))
  batchFactor = factor(meta[, colnames(meta) == batch])
  
  out = reducedMNN(big_pca , batch = batchFactor )
  joint.pca = out$corrected
  reducedDim(sce , reduced.dim_name) = joint.pca
  return(sce)
}

sce_sim = sce


sce_sim = add_batch_corrected_supervised_pca(sce_sim, genes = hvgs, reduced.dim_name = "pca.0" , batch = "sample" , d = 3)

#umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce_sim , "pca.0"))) )
#reducedDim(sce_sim , "UMAP.0") = umaps
reducedDim(sce_sim , "UMAP.0") = reducedDim(sce_sim , "pca.0")


add_simulated_counts <- function(sce, gene, frac_cells_change, range){
  counts = counts(sce)
  current.counts = counts[gene, ]
  idx_2_change = which(sce$type == "cond_B" & sce$celltype %in% c("Erythroid2" , "Erythroid1"))
  idx_2_change = sample(idx_2_change , round(length(idx_2_change)*frac_cells_change))
  current.counts[idx_2_change] = current.counts[idx_2_change] + floor(runif(length(idx_2_change), min=range[1], max=(range[2]+1)))
  counts[gene, ] = current.counts
  counts(sce) = counts
  return(sce)
}



for (i in 1:nrow(markers)){
  print(i)
  sce_sim = add_simulated_counts(sce_sim, 
                               gene = markers$ENSEMBL[i], 
                               range = c(6,8) , 
                               frac_cells_change = 1)
}

sce_sim = scuttle::logNormCounts(sce_sim)
# add re-computed embedding
sce_sim = add_batch_corrected_supervised_pca(sce_sim, genes = hvgs, reduced.dim_name = "pca.1" , batch = "sample" , d = 3)
#umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce_sim , "pca.1"))) )
#reducedDim(sce_sim , "UMAP.1") = umaps
reducedDim(sce_sim , "UMAP.1") = reducedDim(sce_sim , "pca.1")


sce_milo.0 = miloDE::assign_neighbourhoods(sce_sim , reducedDim_name = "pca.0" , order = 1 , k = 75 , d = 5 , verbose = F , filtering = T)
sce_milo.1 = miloDE::assign_neighbourhoods(sce_sim , reducedDim_name = "pca.1" , order = 1 , k = 75 , d = 5 , verbose = F , filtering = T)
da.0 = get_milo_stat( sce_milo.0 , "pca.0")
da.1 = get_milo_stat( sce_milo.1 , "pca.1")


p1 = plot_milo_by_single_metric(sce_milo.0 , da.0 , significance_by = "PValue" , alpha = .5 ,  layout = "UMAP.0")
p1
p2 = plot_milo_by_single_metric(sce_milo.1 , da.1 , significance_by = "PValue" , alpha = .5,  layout = "UMAP.1")
p2

meta = cbind( as.data.frame(colData(sce_milo.0)) , as.data.frame(reducedDim(sce_milo.0 , "UMAP.0")))
p = ggplot(meta , aes(x = V1 , y = V2 , col = type)) +
  geom_point(alpha = .5) +
  theme_bw() 
p
meta = cbind( as.data.frame(colData(sce_milo.1)) , as.data.frame(reducedDim(sce_milo.1 , "UMAP.1")))
p = ggplot(meta , aes(x = V1 , y = V2 , col = type)) +
  geom_point(alpha = .5) +
  theme_bw() 
p




```

# Control - no perturbation

```{r control-no-perturbation, message = FALSE}



sces = readRDS( paste0(root.dir , "data/processed/da_de/simulations_chimera/blood/sces_simulated.Rds") )

sce = sces[[1]]
umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce , "pca.simulations"))) )
reducedDim(sce , "UMAP") = umaps

sce_milo = miloDE::assign_neighbourhoods(sce , reducedDim_name = "pca.simulations" , order = 1 , k = 100 , d = 5 , verbose = F , filtering = T)


get_milo_stat = function(sce_milo , reducedDim_name ){
  require(miloR)
  require(dplyr)
  
  sce_milo$sample <- as.factor( sce_milo$sample )
  sce_milo$type <- as.factor( sce_milo$type )
  
  sce_milo <- countCells(sce_milo, meta.data = as.data.frame(colData(sce_milo)), samples="sample")
  sce_design <- data.frame(colData(sce_milo))[,c("sample", "type")]
  sce_design <- distinct(sce_design)
  rownames(sce_design) <- sce_design$sample
  nhoodCounts(sce_milo) = as.matrix(nhoodCounts(sce_milo) , "dgCMatrix")
  
  out = testNhoods(sce_milo, design = ~ type , design.df = sce_design, fdr.weighting = "graph-overlap", reduced.dim = reducedDim_name)
  #out = annotateNhoods(sce_milo , out , coldata_col = "celltype")
  out$reducedDim_name = reducedDim_name
  out$n_hoods = nrow(out)
  out$n_cells_per_hood = colSums(nhoods(sce_milo))
  return(out)
}


da_stat = get_milo_stat(sce_milo , "pca.simulations" )

p1 = plot_milo_by_single_metric(sce_milo , da_stat , significance_by = "SpatialFDR")
p1
p2 = plot_milo_by_single_metric(sce_milo , da_stat , colour_by = "celltype")
p2




```



# Get stat for each simulation/nhood assignment

For each simulation and nhood assignment - calculate:

- Per nhood stat:
* DA
* how many marker genes are DE
* how many not marker genes are DE

- Combined stat (across all nhoods):
* frac of DA nhoods
* avg (across marker genes) of how often each marker gene is DE
* avg (across not marker genes) of how often each not marker gene is DE

```{r get-stat, message = FALSE}


get_stat_per_sim_and_nhood_assignment = function(id_sim , id_nhood_assignment , spatialFDR_DA.thresh = 0.1 , spatialFDR_DE.thresh = 0.1){
  current.stat_da = stat_da[stat_da$id_sim == id_sim & stat_da$id_nhood_assignment == id_nhood_assignment , ]
  current.stat_da = as.data.frame(current.stat_da %>% group_by() %>% 
                                    dplyr::summarise(frac_hoods_DA = mean(SpatialFDR <= spatialFDR_DA.thresh , na.rm = T)))
    
  #current.stat_de = stat_de[stat_de$id_sim == id_sim & stat_de$id_nhood_assignment == id_nhood_assignment , ]
  #current.stat_de = as.data.frame(current.stat_de %>% group_by(ENSEMBL , SYMBOL , gene_type) %>% 
  #                                  dplyr::summarise(frac_hoods_DE = mean(pval_corrected_across_nhoods <= spatialFDR_DE.thresh , na.rm = T)))
  #current.stat_de = as.data.frame(current.stat_de %>% group_by(gene_type) %>% 
  #                                  dplyr::summarise(frac_hoods_DE = mean(frac_hoods_DE)))
  #out = cbind(current.stat_da , current.stat_de)
  out = current.stat_da
  out$id_sim = as.character(id_sim)
  out$id_nhood_assignment = as.character(id_nhood_assignment)
  return(out)
}


anno_sims = expand.grid(id_sim = unique(stat_da$id_sim), id_nhood_assignment = unique(stat_da$id_nhood_assignment) )

stat = bplapply(1:nrow(anno_sims) , function(i){
  out = get_stat_per_sim_and_nhood_assignment(anno_sims$id_sim[i] , anno_sims$id_nhood_assignment[i])
  return(out)
} , BPPARAM = mcparam)
stat = do.call(rbind , stat)
stat = merge(stat , unique(stat_da[, c("id_sim" , "n_markers" , "n_not_markers", "round_sim" , "order" , "k" , "seed" , "id_nhood_assignment")]) ,
             by = c("id_sim" , "id_nhood_assignment") , all.x = T)


stat = as.data.frame(stat %>% group_by(n_markers , n_not_markers) %>% dplyr::summarise(frac = mean(frac_hoods_DA)))


p = ggplot(stat , aes(x = n_markers , y = n_not_markers , fill = frac)) +
  geom_tile()
p



sce = sces[[75]]
umaps = as.data.frame( scater::calculateUMAP(t(reducedDim(sce , "pca.simulations"))) )
reducedDim(sce , "UMAP") = umaps

current.genes = simulated_genes[[75]]


get_plot_per_gene = function(gene){
  meta = as.data.frame(colData(sce))
  meta$counts = as.numeric(counts(sce[gene,]))
  meta$logcounts = as.numeric(logcounts(sce[gene,]))
  
  p = ggplot(meta , aes(x = type , fill = celltype , y = counts)) +
    geom_boxplot()
  p
  
}




```

# Session Info

```{r sessinf}
sessionInfo()
```
